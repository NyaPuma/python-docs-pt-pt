# Run some tests in the Python Doc translations

name: Check

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Branch name corresponding to a Python version"
        required: true
        type: string
      tx_project:
        description: "Name of the Transifex translation project"
        required: true
        type: string
  workflow_call:
    inputs:
      version:
        description: "Branch name corresponding to a Python version"
        required: true
        type: string
      tx_project:
        description: "Name of the Transifex translation project"
        required: true
        type: string
    # Segredos relacionados ao Telegram foram removidos

permissions:
  contents: read

env:
  PYDOC_LANGUAGE: pt_PT
  PYDOC_REPO: ${{ github.server_url }}/${{ github.repository }}
  PYDOC_VERSION: ${{ inputs.version }}

jobs:

  # Build documentation handling warnings as errors in both HTML and PDF.
  # If success, upload built docs as artifact.
  # If failure in HTML, upload logs.
  build:
    name: Build docs
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        format: [ html, latex, epub ]
    steps:
      - name: Check out repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 5

      - name: ⚙️ Set execution permissions for scripts
        # Garante que os scripts setup.sh, build.sh e prepmsg.sh são executáveis.
        run: |
          chmod +x scripts/setup.sh
          chmod +x scripts/build.sh
          chmod +x scripts/prepmsg.sh

      - name: Set up Python 3
        uses: actions/setup-python@v6
        with:
          python-version: ${{ inputs.version }}
          cache: pip
          allow-prereleases: true

      - name: Make sure the repository is up to date
        if: github.event_name != 'pull_request'
        run: git pull --rebase

      - name: setup
        # Agora o scripts/setup.sh será executado sem erro de permissão
        run: ./scripts/setup.sh

      - name: Add problem matcher
        uses: sphinx-doc/github-problem-matcher@v1.1

      - name: Build docs
        id: build
        # Agora o scripts/build.sh será executado sem erro de permissão
        run: ./scripts/build.sh ${{ matrix.format }}

      # O passo 'Prepare notification' foi removido

      - name: Upload artifact - log files
        if: always() && steps.build.outcome == 'failure'
        uses: actions/upload-artifact@v5
        with:
          name: logs-${{ inputs.version }}-${{ matrix.format }}
          path: logs/*
          
      - name: Upload artifact - docs
        if: always() && steps.build.outcome == 'success'
        uses: actions/upload-artifact@v5
        with:
          name: python-docs-pt-pt-${{ inputs.version }}-${{ matrix.format }}
          path: cpython/Doc/build/${{ matrix.format }}

  # Build Python docs in PDF format and make available for download.
  output-pdf:
    name: Build docs (pdf)
    runs-on: ubuntu-latest
    needs: [ 'build' ]
    steps:
      - uses: actions/download-artifact@v6
        with:
          name: python-docs-pt-pt-${{ inputs.version }}-latex
      - run: sudo apt-get update
      - run: sudo apt-get install -y latexmk texlive-xetex fonts-freefont-otf xindy texlive-lang-portuguese
      # NOTA: O 'make' aqui assume que o Makefile não chama scripts externos sem permissão,
      # ou que as permissões foram tratadas no job 'build' (que é onde o latex é construído).
      - run: make
      - uses: actions/upload-artifact@v5
        if: always()
        with:
          name: python-docs-pt-pt-${{ inputs.version }}-pdf
          path: ./*.pdf

  # Run sphinx-lint to find wrong reST syntax in PO files. Always store logs.
  # If issues are found, upload logs.
  lint:
    name: Lint translations
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 5

      - name: ⚙️ Set execution permissions for scripts
        # Garante que os scripts setup.sh, lint.sh e prepmsg.sh são executáveis.
        run: |
          chmod +x scripts/setup.sh
          chmod +x scripts/lint.sh
          chmod +x scripts/prepmsg.sh

      - name: Set up Python 3
        uses: actions/setup-python@v6
        with:
          python-version: ${{ inputs.version }}
          cache: pip
          allow-prereleases: true

      - name: Make sure the repository is up to date
        if: github.event_name != 'pull_request'
        run: git pull --rebase

      - name: setup
        # Agora o scripts/setup.sh será executado sem erro de permissão
        run: ./scripts/setup.sh

      - name: Add problem matcher
        uses: rffontenelle/sphinx-lint-problem-matcher@v1.0.0

      - name: lint translations files
        id: lint
        # Agora o scripts/lint.sh será executado sem erro de permissão
        run: ./scripts/lint.sh

      # O passo 'Prepare notification' foi removido

      - name: Upload artifact - log files
        if: always() && steps.lint.outcome == 'failure'
        uses: actions/upload-artifact@v5
        with:
          name: ${{ inputs.version }}-lint-logs
          path: logs/*


  # Check for zero-width space charcters in translations.
  # These are known to come together with (some?) machine translation like Google translate,
  # and - as one of the consequences - it may avoid Transifex glossary matching (e.g. variáveis)
  zero-width-space:
    name: Check for zero-width space characters
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
        with:
          ref: ${{ inputs.version }}

      - name: Make sure the repository is up to date
        if: github.event_name != 'pull_request'
        run: git pull --rebase

      - name: Remove zero-width space characters
        run: |
          sed -i 's/\xe2\x80\x8b//g' *.po **/*.po
          # Undo removal from where we should not
          sed -i 's|`````|``\xe2\x80\x8b`\xe2\x80\x8b``|' reference/lexical_analysis.po

      - name: Show difference (error if there is any)
        run: |
          git diff --exit-code --color-words
